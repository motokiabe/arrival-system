<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>送信パネル Pro</title>
    <style>
        body { text-align:center; padding-top:30px; background:#1a1a1a; font-family:sans-serif; transition: 0.3s; color: white; }
        .btn { width:90%; padding:35px; font-size:24px; color:white; border:none; border-radius:20px; font-weight:bold; margin-bottom:25px; box-shadow:0 6px 15px rgba(0,0,0,0.5); }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        .btn-5 { background:#007aff; }
        .btn-3 { background:#34c759; }
        .btn-reset { background:#8e8e93; }
        #status { font-size: 18px; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <button onclick="send('start5')" class="btn btn-5">到着 5分前</button>
    <button onclick="send('start3')" class="btn btn-3">到着 3分前</button>
    <button onclick="send('waiting')" class="btn btn-reset">待機画面に戻す</button>
    <div id="status">● 待機中</div>

    <script>
    async function send(command) {
        const statusEl = document.getElementById('status');
        statusEl.innerText = "● 送信中...";
        statusEl.style.color = "#ff9500";
        
        let token = localStorage.getItem('gh_token_pro');
        if (!token) {
            token = prompt("新しいGitHubトークンを入力してください");
            if (token) localStorage.setItem('gh_token_pro', token);
            else return;
        }

        try {
            // 1. 現在のファイル情報を取得
            const res = await fetch(`https://api.github.com/repos/motokiabe/arrival-system/contents/signal.json`, {
                headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' }
            });
            if (!res.ok) throw new Error("Token Error");
            const fileData = await res.json();
            
            // 2. 書き込み（タイムスタンプを付与して重複を防止）
            const content = btoa(JSON.stringify({status: command, time: Date.now()}));
            const update = await fetch(`https://api.github.com/repos/motokiabe/arrival-system/contents/signal.json`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "update", content: content, sha: fileData.sha })
            });

            if (update.ok) {
                document.body.style.backgroundColor = "#004d40";
                statusEl.innerText = "● 送信成功";
                statusEl.style.color = "#4cd964";
                if (navigator.vibrate) navigator.vibrate(200); // 成功時にブルッ
                setTimeout(() => { document.body.style.backgroundColor = "#1a1a1a"; }, 1500);
            } else { throw new Error(); }
        } catch (e) {
            document.body.style.backgroundColor = "#4a1a1a";
            statusEl.innerText = "● 送信失敗（トークンを確認）";
            statusEl.style.color = "#ff3b30";
            localStorage.removeItem('gh_token_pro'); // 失敗時は入力をやり直させる
        }
    }
    </script>
</body>
</html>

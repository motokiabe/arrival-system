<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>到着案内 Pro (Legacy Support)</title>
    <style>
        body { margin: 0; background-color: #000; color: #fff; font-family: "Helvetica", "Hiragino Sans", sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #standby-image { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #display-area { text-align: center; width: 100%; z-index: 10; }
        #label { font-size: 2.5rem; color: #888; margin-bottom: -1rem; }
        #main-timer { font-size: 18rem; font-weight: bold; line-height: 1; letter-spacing: -5px; }
        .unit { font-size: 6rem; margin-left: 0.5rem; }
        #sub-message { font-size: 4rem; color: #ffffff; display: none; }

        /* 古いSafariでも動きやすい単純なアニメーション */
        .breathe { animation: breathe-legacy 4s infinite; -webkit-animation: breathe-legacy 4s infinite; }
        @keyframes breathe-legacy { 0% { opacity: 0.3; } 50% { opacity: 1.0; } 100% { opacity: 0.3; } }
        @-webkit-keyframes breathe-legacy { 0% { opacity: 0.3; } 50% { opacity: 1.0; } 100% { opacity: 0.3; } }

        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; justify-content: center; align-items: center; }
        #start-btn { padding: 30px 60px; font-size: 2rem; border: 1px solid #fff; background: #222; color: #fff; border-radius: 15px; }
    </style>
</head>
<body>
    <div id="start-overlay" onclick="setupAudio()">
        <button id="start-btn">システムを開始する</button>
    </div>

    <img id="standby-image" src="https://raw.githubusercontent.com/motokiabe/arrival-system/main/IMG_2788.png">
    <div id="display-area">
        <div id="timer-container" style="display: none;">
            <div id="label">到着まで</div>
            <div id="main-timer"></div>
            <div id="sub-message" class="breathe">まもなく到着します</div>
        </div>
    </div>
    
    <audio id="chime" src="https://raw.githubusercontent.com/motokiabe/arrival-system/main/chime.mp3" preload="auto"></audio>

<script>
    var GAS_URL = "https://script.google.com/macros/s/AKfycbx2WTj1Oe5geWffuMiuDb2stacmHaK3D9_zyoCZqyH18u39vyLaUWyLg787aReGfTbA/exec"; 
    var timeLeft = 0;
    var timerId = null;
    var lastStatus = "0";
    var lastMinute = -1;

    // iOS 9以前でも動く古い書き方に変更
    function setupAudio() {
        var chime = document.getElementById('chime');
        chime.play();
        chime.pause();
        chime.currentTime = 0;
        document.getElementById('start-overlay').style.display = 'none';
        setInterval(check, 3000); // 負荷軽減のため少し間隔をあける
    }

    function check() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", GAS_URL + "?t=" + new Date().getTime(), true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var status = xhr.responseText;
                if (status !== lastStatus) {
                    if (status === "0") stopTimer();
                    else {
                        var mins = parseInt(status);
                        if (!isNaN(mins) && mins > 0) start(mins * 60);
                    }
                    lastStatus = status;
                }
            }
        };
        xhr.send();
    }

    function start(sec) {
        timeLeft = sec;
        lastMinute = Math.ceil(timeLeft / 60);
        document.getElementById('standby-image').style.display = 'none';
        document.getElementById('timer-container').style.display = 'block';
        document.getElementById('main-timer').style.display = 'block';
        document.getElementById('label').style.display = 'block';
        document.getElementById('sub-message').style.display = 'none';
        document.getElementById('main-timer').innerHTML = lastMinute + '<span class="unit">分</span>';
        
        if (sec === 300) {
            document.getElementById('chime').play();
        }

        if(timerId) clearInterval(timerId);
        timerId = setInterval(function() {
            timeLeft--;
            var currentMin = Math.ceil(timeLeft / 60);
            if(timeLeft > 30) {
                document.getElementById('main-timer').innerHTML = currentMin + '<span class="unit">分</span>';
            } else if (timeLeft <= 30 && timeLeft > 0) {
                document.getElementById('label').style.display = 'none';
                document.getElementById('main-timer').style.display = 'none';
                document.getElementById('sub-message').style.display = 'block';
            } else {
                finishSequence();
            }
        }, 1000);
    }

    function stopTimer() {
        if(timerId) clearInterval(timerId);
        timerId = null;
        document.getElementById('standby-image').style.display = 'block';
        document.getElementById('timer-container').style.display = 'none';
        lastStatus = "0";
    }

    function finishSequence() {
        clearInterval(timerId);
        timerId = null;
        document.getElementById('timer-container').style.display = 'none';
        setTimeout(function() { if (!timerId) document.getElementById('standby-image').style.display = 'block'; }, 10000);
    }
</script>
</body>
</html>

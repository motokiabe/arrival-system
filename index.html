<script>
    const GAS_URL = "ここに新しいデプロイURLを貼る"; 
    let timerId = null;
    let isMonitoring = false;

    async function setupAudio() {
        const chime = document.getElementById('chime');
        const chime2 = document.getElementById('chime2');
        const alive = document.getElementById('keep-alive');
        
        // 音声を鳴らす権利を確定
        [chime, chime2].forEach(c => { c.play().then(() => { c.pause(); c.currentTime = 0; }).catch(e=>{}); });
        alive.play().catch(e=>{}); 
        
        document.getElementById('start-overlay').style.display = 'none';

        // 起動時のリセットを「待ち」にせず、エラーでも次へ進むように修正
        fetch(`${GAS_URL}?status=0&t=${Date.now()}`).catch(e=>{});
        
        setTimeout(() => {
            isMonitoring = true;
            setInterval(check, 2000);
        }, 1000);
    }

    async function check() {
        if (!isMonitoring) return;
        try {
            // URLの末尾に毎回違う数字(t=...)をつけて、iPadが「古いデータ」を使わないようにする
            const res = await fetch(`${GAS_URL}?t=${Date.now()}`);
            const status = await res.text();
            
            // 指示が届いた時だけ処理
            if (status !== "0" && status !== "" && status.length < 10) { 
                handleStatusChange(status);
            }
        } catch (e) {}
    }

    function handleStatusChange(status) {
        const s = status.toLowerCase();
        const isRightLeft = s.includes("right") || s.includes("left");
        forcePlayChime(isRightLeft ? 'chime2' : 'chime');

        if (s.includes("right")) {
            showCustomImage('right-image');
        } else if (s.includes("left")) {
            showCustomImage('left-image');
        } else {
            const mins = parseInt(status);
            if (!isNaN(mins) && mins > 0) start(mins * 60);
        }
    }
    
    // 以下、既存の関数（forcePlayChime, start, updateDisplay, triggerFlash, stopTimer, finishSequence）は変更なしでOK
</script>
